{% extends "parent.html" %}

{% block title %} - {{juggler.get_name}}{% endblock %}

{% block content %}
<h2>{{juggler.get_name}} - Score: {{juggler.score|floatformat:2}}</h2>
{% if not has_user_account and not request.user.is_authenticated %}
<h3><a href="../../register/{{juggler.id}}">Claim this Juggler Account</a></h3>
{% endif %}
<div id="score_vs_time_chart" style="width:300px; height:200px;"></div>
{% if editable %}<form action="alter_achievements" method="post">{% endif %}
<h3>Challengeable Achievements</h3>
<table id="challengeable" class="display">
  <thead>
    <tr>
        <th>Achievement</th>
        <th>Value</th>
        <th>Type</th>
        <th>Date Achieved</th>
    </tr>
  </thead>
  <tbody>
    {% for ach in challengeable %}
    <tr>
        <td><a href="../../achievement/{{ach.achievement.id}}">{{ach.achievement.name}}</a></td>
        <td class="value">{{ach.achievement.value|floatformat:2}}</td>
        <td>{{ach.achievement.get_kind_display|title}}</td>
        <td>{{ach.date_created|date:"M d, Y @ H:i"}}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<br /> 
{% if editable %}
    <input class="submit_button" type="submit" value="Submit" />
{% endif %}
<h3>Achievements</h3>
<table id="achieved" class="display">
  <thead>
    <tr>
        {% if editable %}<th>Remove?</th>{% endif %}
        {% if editable %}<th>Challenge?</th>{% endif %}
        <th>Achievement</th>
        <th>Value</th>
        <th>Type</th>
        <th>Date Achieved</th>
    </tr>
  </thead>
  <tbody>
    {% for ach in achievements %}
    <tr>
        {% if editable %}<td><input type="checkbox" name="remove" value="{{ach.achievement.id}}" /></td>{% endif %}
        {% if editable %}<td><input type="checkbox" name="challenge" value="{{ach.achievement.id}}" /></td>{% endif %}
        <td><a href="../../achievement/{{ach.achievement.id}}">{{ach.achievement.name}}</a></td>
        <td class="value">{{ach.achievement.value|floatformat:2}}</td>
        <td>{{ach.achievement.get_kind_display|title}}</td>
        <td>{{ach.date_created|date:"M d, Y @ H:i"}}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<br /> 
{% if editable %}
    <input class="submit_button" type="submit" value="Submit" />
{% endif %}
<h3>Achievements Not Yet Achieved</h3>
    <table id="unachieved" class="display">
      <thead>
        <tr>
            {% if editable %}<th>Add?</th>{% endif %}
            <th>Achievement</th>
            <th>Value</th>
            <th>Type</th>
        </tr>
      </thead>
      <tbody>
        {% for unach in unachieved %}
        <tr>
            {% if editable %}<td><input type="checkbox" name="add" value="{{ unach.id }}" /></td>{% endif %}
            <td><a href="../../achievement/{{unach.id}}">{{unach.name}}</a></td>
            <td class="value">{{unach.value|floatformat:2}}</td>
            <td>{{unach.get_kind_display|title}}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <br />
{% if editable %}
    <input class="submit_button" type="submit" value="Submit" />
</form>
{% endif %}
{% endblock %}

{% block initjs %}
<script type="text/javascript">
$(document).ready(function() {
  var renderNAs = function(obj) {
    if (obj.aData[2] == "101.00")
      return "N/A";
    return obj.aData[2];
  }

  {% if editable %}
  var defaultsort = [1, 3, 2];
  var cols = [[], [null, null], [null]];
  {% else %}
  var defaultsort = [1, 1, 1];
  var cols = [[], [], []];
  {% endif %}

  var t0 = $('#challengeable').dataTable({
    "bPaginate": false,
    "aaSorting": [[ defaultsort[0], "asc" ]],
    "aoColumns": cols[0].concat([{"sType": "html"},
            {"sType": "numeric",
             "fnRender": renderNAs,
             "bUseRendered": false},
             null, null])
  });
  var t1 = $('#achieved').dataTable({
    "bPaginate": false,
    "aaSorting": [[ defaultsort[1], "asc" ]],
    "aoColumns": cols[1].concat([{"sType": "html"},
            {"sType": "numeric",
             "fnRender": renderNAs,
             "bUseRendered": false},
             null, null])
  });
  var t2 = $('#unachieved').dataTable({
    "bPaginate": false,
    "aaSorting": [[ defaultsort[2], "asc" ]],
    "aoColumns": cols[2].concat([{"sType": "html"},
            {"sType": "numeric",
             "fnRender": renderNAs,
             "bUseRendered": false},
             null])
  });

  $.map([t1, t2], function(table) {
    var values = [''];
    table.find('td.value').each(function() {
      var value = $(this).html();
      var exists = false;
      for(var i = 0; i< values.length; i++) {
        if(values[i] === value) {
          exists = true;
          break;
        }
      }
      if(!exists) {
        values.push(value);
      }
    });
    var valueFilter = $('<select></select>').attr('name', 'value');
    var makeOption = function(value) {
      var option = $('<option></option>').attr('value', value).html((value === '') ? 'All' : value);
      valueFilter.append(option);
    };
    $.map(values, makeOption);
    valueFilter.change(function() {
      if (this.value == "N/A")
        table.fnFilter("101.00", 2);
      else
        table.fnFilter(this.value, 2);
    });
    $("#" + table.attr('id') + "_filter").before($('<label></label>').html('Show Achievements with Value: ').append(valueFilter));
  });
  //draw chart
  var options = {
    lines: { show: true },
    points: { show: true },
    xaxis: { mode: 'time'},
    yaxis: { min: 0 },
    grid: { hoverable: true }
  };
  var data = [];
  var chartdiv = $("#score_vs_time_chart");
    
  var onDataReceived = function(series) {
      data = [series.data];
      bindTooltip(chartdiv, [series.info]);
      $.plot(chartdiv, data, options);
  };
        
  $.ajax({
    url: 'score_chart_data',
    method: 'GET',
    dataType: 'json',
    success: onDataReceived
  }); 
});
</script>
{% endblock %}
